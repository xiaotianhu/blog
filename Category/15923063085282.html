<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  PHP的多线程Curl,rolling Curl实现与坑 - Rainyluo's BLOG
  
  </title>
 <meta name="description" content="">
 <link href="atom.xml" rel="alternate" title="Rainyluo's BLOG" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />

    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
    <script src="asset/highlightjs/highlight.pack.js"></script>
    <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
    <script>hljs.initHighlightingOnLoad();</script>
    
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>

<div id="header">
    <h1><a href="index.html">Rainyluo's BLOG</a></h1>
</div>

</nav>
        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; Rainyluo's BLOG</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
      <li><a href="index.html">Home</a></li>
      
        <li class="divider"></li>
        <li><label>Hyperf</label></li>

          
            <li><a title="# Hyperf源码阅读 第二章 HTTP服务初始化" href="15932480961729.html"># Hyperf源码阅读 第二章 HTTP服务初始化</a></li>
          
            <li><a title="Hyperf源码阅读 第一章 初始化" href="15928236190986.html">Hyperf源码阅读 第一章 初始化</a></li>
          

      
        <li class="divider"></li>
        <li><label>随感</label></li>

          
            <li><a title="如何变得平庸" href="15923063082122.html">如何变得平庸</a></li>
          
            <li><a title="一个实用主义者的反思" href="15923063082072.html">一个实用主义者的反思</a></li>
          
            <li><a title="2018-08-01 感想" href="15923063081475.html">2018-08-01 感想</a></li>
          
            <li><a title="2019的成长" href="15923063084995.html">2019的成长</a></li>
          
            <li><a title="细节与功利主义：致那些同我一样想突破自己技术层级的朋友们" href="15771974682027.html">细节与功利主义：致那些同我一样想突破自己技术层级的朋友们</a></li>
          
            <li><a title="审美是一切美好追求的基础" href="15706010504336.html">审美是一切美好追求的基础</a></li>
          
            <li><a title="什么叫"回归初心" 以及技术成长突破的心态" href="15696591889118.html">什么叫"回归初心" 以及技术成长突破的心态</a></li>
          

      
        <li class="divider"></li>
        <li><label>其他</label></li>

          
            <li><a title="理解矩阵" href="15936798966495.html">理解矩阵</a></li>
          
            <li><a title="cocopods重装解决framework not found Pods/no such module" href="15923063082414.html">cocopods重装解决framework not found Pods/no such module</a></li>
          
            <li><a title="pts导入bts2.0教程" href="15923063083603.html">pts导入bts2.0教程</a></li>
          
            <li><a title="gopush代码分析-comet模块" href="15923063083769.html">gopush代码分析-comet模块</a></li>
          
            <li><a title="Chrome Extension扩展开发之复制粘贴" href="15923063083833.html">Chrome Extension扩展开发之复制粘贴</a></li>
          
            <li><a title="iowait详解" href="15923063084125.html">iowait详解</a></li>
          
            <li><a title="mac安装mysql-python(with XAMPP)" href="15923063084788.html">mac安装mysql-python(with XAMPP)</a></li>
          
            <li><a title="App内使用H5页面的一个安全问题" href="15923063086512.html">App内使用H5页面的一个安全问题</a></li>
          
            <li><a title="PHP 通过Apns给Ios设备推送Notification" href="15923063086602.html">PHP 通过Apns给Ios设备推送Notification</a></li>
          
            <li><a title="python中使用import加载目录中全部文件" href="15923063087292.html">python中使用import加载目录中全部文件</a></li>
          
            <li><a title="kvm/virsh 异常断电导致虚拟机无法启动的修复实战" href="15923063088164.html">kvm/virsh 异常断电导致虚拟机无法启动的修复实战</a></li>
          
            <li><a title="Synology office error: User home service is not enabled" href="15923063081281.html">Synology office error: User home service is not enabled</a></li>
          
            <li><a title="git commit后自动检查php文件语法" href="15923063081235.html">git commit后自动检查php文件语法</a></li>
          
            <li><a title="梅林固件/R6300V2 安装Lcd4Linux显示屏" href="15923063081215.html">梅林固件/R6300V2 安装Lcd4Linux显示屏</a></li>
          

      
        <li class="divider"></li>
        <li><label>About</label></li>

          
            <li><a title="Rainyluo's Blog" href="15923063081658.html">Rainyluo's Blog</a></li>
          

      
        <li class="divider"></li>
        <li><label>PHP</label></li>

          
            <li><a title="二维数组排序 array multisort" href="15756185241314.html">二维数组排序 array multisort</a></li>
          
            <li><a title="PHP中的闭包理解" href="15931630289738.html">PHP中的闭包理解</a></li>
          
            <li><a title="reactPHP + lumen性能简测" href="15923063083212.html">reactPHP + lumen性能简测</a></li>
          
            <li><a title="QueryPath中文乱码问题,UTF8乱码问题解决" href="15923063084242.html">QueryPath中文乱码问题,UTF8乱码问题解决</a></li>
          
            <li><a title="WorkerMan的restart命令的一个Bug修复记录" href="15923063084445.html">WorkerMan的restart命令的一个Bug修复记录</a></li>
          
            <li><a title="PHP的多线程Curl,rolling Curl实现与坑" href="15923063085282.html">PHP的多线程Curl,rolling Curl实现与坑</a></li>
          
            <li><a title="用PHP-CLI在SHELL中输出颜色" href="15923063085495.html">用PHP-CLI在SHELL中输出颜色</a></li>
          
            <li><a title="使用GITHUB+JustWriting搭建BLOG" href="15923063087852.html">使用GITHUB+JustWriting搭建BLOG</a></li>
          
            <li><a title="[原创翻译]QueryPath PHP的Jquery实现,QueryPath教程" href="15923063087972.html">[原创翻译]QueryPath PHP的Jquery实现,QueryPath教程</a></li>
          
            <li><a title="(伪)异步实现加速PHP接口的返回速度" href="15923063089153.html">(伪)异步实现加速PHP接口的返回速度</a></li>
          
            <li><a title="PHP调试技巧" href="15922725010749.html">PHP调试技巧</a></li>
          

      
      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>

        <section id="main-content" role="main" class="scroll-container">

          <div class="row">
            <div class="large-3 medium-3 columns">
              <div class="hide-for-small">
                <div class="sidebar">
                <nav>
                  <ul id="side-nav" class="side-nav">

                    
                      <li class="side-title"><span>Hyperf</span></li>
                        
                          <li><a title="# Hyperf源码阅读 第二章 HTTP服务初始化" href="15932480961729.html"># Hyperf源码阅读 第二章 HTTP服务初始化</a></li>
                        
                          <li><a title="Hyperf源码阅读 第一章 初始化" href="15928236190986.html">Hyperf源码阅读 第一章 初始化</a></li>
                        

                    
                      <li class="side-title"><span>随感</span></li>
                        
                          <li><a title="如何变得平庸" href="15923063082122.html">如何变得平庸</a></li>
                        
                          <li><a title="一个实用主义者的反思" href="15923063082072.html">一个实用主义者的反思</a></li>
                        
                          <li><a title="2018-08-01 感想" href="15923063081475.html">2018-08-01 感想</a></li>
                        
                          <li><a title="2019的成长" href="15923063084995.html">2019的成长</a></li>
                        
                          <li><a title="细节与功利主义：致那些同我一样想突破自己技术层级的朋友们" href="15771974682027.html">细节与功利主义：致那些同我一样想突破自己技术层级的朋友们</a></li>
                        
                          <li><a title="审美是一切美好追求的基础" href="15706010504336.html">审美是一切美好追求的基础</a></li>
                        
                          <li><a title="什么叫"回归初心" 以及技术成长突破的心态" href="15696591889118.html">什么叫"回归初心" 以及技术成长突破的心态</a></li>
                        

                    
                      <li class="side-title"><span>其他</span></li>
                        
                          <li><a title="理解矩阵" href="15936798966495.html">理解矩阵</a></li>
                        
                          <li><a title="cocopods重装解决framework not found Pods/no such module" href="15923063082414.html">cocopods重装解决framework not found Pods/no such module</a></li>
                        
                          <li><a title="pts导入bts2.0教程" href="15923063083603.html">pts导入bts2.0教程</a></li>
                        
                          <li><a title="gopush代码分析-comet模块" href="15923063083769.html">gopush代码分析-comet模块</a></li>
                        
                          <li><a title="Chrome Extension扩展开发之复制粘贴" href="15923063083833.html">Chrome Extension扩展开发之复制粘贴</a></li>
                        
                          <li><a title="iowait详解" href="15923063084125.html">iowait详解</a></li>
                        
                          <li><a title="mac安装mysql-python(with XAMPP)" href="15923063084788.html">mac安装mysql-python(with XAMPP)</a></li>
                        
                          <li><a title="App内使用H5页面的一个安全问题" href="15923063086512.html">App内使用H5页面的一个安全问题</a></li>
                        
                          <li><a title="PHP 通过Apns给Ios设备推送Notification" href="15923063086602.html">PHP 通过Apns给Ios设备推送Notification</a></li>
                        
                          <li><a title="python中使用import加载目录中全部文件" href="15923063087292.html">python中使用import加载目录中全部文件</a></li>
                        
                          <li><a title="kvm/virsh 异常断电导致虚拟机无法启动的修复实战" href="15923063088164.html">kvm/virsh 异常断电导致虚拟机无法启动的修复实战</a></li>
                        
                          <li><a title="Synology office error: User home service is not enabled" href="15923063081281.html">Synology office error: User home service is not enabled</a></li>
                        
                          <li><a title="git commit后自动检查php文件语法" href="15923063081235.html">git commit后自动检查php文件语法</a></li>
                        
                          <li><a title="梅林固件/R6300V2 安装Lcd4Linux显示屏" href="15923063081215.html">梅林固件/R6300V2 安装Lcd4Linux显示屏</a></li>
                        

                    
                      <li class="side-title"><span>About</span></li>
                        
                          <li><a title="Rainyluo's Blog" href="15923063081658.html">Rainyluo's Blog</a></li>
                        

                    
                      <li class="side-title"><span>PHP</span></li>
                        
                          <li><a title="二维数组排序 array multisort" href="15756185241314.html">二维数组排序 array multisort</a></li>
                        
                          <li><a title="PHP中的闭包理解" href="15931630289738.html">PHP中的闭包理解</a></li>
                        
                          <li><a title="reactPHP + lumen性能简测" href="15923063083212.html">reactPHP + lumen性能简测</a></li>
                        
                          <li><a title="QueryPath中文乱码问题,UTF8乱码问题解决" href="15923063084242.html">QueryPath中文乱码问题,UTF8乱码问题解决</a></li>
                        
                          <li><a title="WorkerMan的restart命令的一个Bug修复记录" href="15923063084445.html">WorkerMan的restart命令的一个Bug修复记录</a></li>
                        
                          <li><a title="PHP的多线程Curl,rolling Curl实现与坑" href="15923063085282.html">PHP的多线程Curl,rolling Curl实现与坑</a></li>
                        
                          <li><a title="用PHP-CLI在SHELL中输出颜色" href="15923063085495.html">用PHP-CLI在SHELL中输出颜色</a></li>
                        
                          <li><a title="使用GITHUB+JustWriting搭建BLOG" href="15923063087852.html">使用GITHUB+JustWriting搭建BLOG</a></li>
                        
                          <li><a title="[原创翻译]QueryPath PHP的Jquery实现,QueryPath教程" href="15923063087972.html">[原创翻译]QueryPath PHP的Jquery实现,QueryPath教程</a></li>
                        
                          <li><a title="(伪)异步实现加速PHP接口的返回速度" href="15923063089153.html">(伪)异步实现加速PHP接口的返回速度</a></li>
                        
                          <li><a title="PHP调试技巧" href="15922725010749.html">PHP调试技巧</a></li>
                        

                    
                  </ul>
                </nav>
                </div>
              </div>
            </div>
            <div class="large-9 medium-9 columns">

 <div class="markdown-body">
<h1>PHP的多线程Curl,rolling Curl实现与坑</h1>

<p>Tags:  PHP curl mutil_curl 多线程<br/>
Toc:no<br/>
Status: public<br/>
Position: 1</p>

<p>最近需要做群发推送,之前的推送只有单发的API,因为分IOS跟安卓平台,最简单的实现还是塞到队列去一个一个发,毕竟用户不多也就几万个.之前的请求队列没用多线程请求,每次一个.然而这个推送接口速度太挫,ios经常要2-3s才返回,几万个单线程请求得等死了.于是开始研究PHP的多线程Curl<br/>
  之前知道有mutil_curl可以实现,以为很简单.实际操作起来,坑还是相当多的.</p>

<p>php手册参考：</p>

<blockquote>
<p><a href="http://php.net/manual/zh/book.curl.php">http://php.net/manual/zh/book.curl.php</a></p>
</blockquote>

<p>curl_multi_init()相关：</p>

<blockquote>
<p><a href="http://php.net/manual/zh/function.curl-multi-init.php">http://php.net/manual/zh/function.curl-multi-init.php</a></p>
</blockquote>

<p>手册说的很简单，并附了一个演示脚本，如下。</p>

<pre><code class="language-text">&lt;?php
// 创建一对cURL资源
$ch1 = curl_init();
$ch2 = curl_init();
 
// 设置URL和相应的选项
curl_setopt($ch1, CURLOPT_URL, &quot;http://www.example.com/&quot;);
curl_setopt($ch1, CURLOPT_HEADER, 0);
curl_setopt($ch2, CURLOPT_URL, &quot;http://www.php.net/&quot;);
curl_setopt($ch2, CURLOPT_HEADER, 0);
 
// 创建批处理cURL句柄
$mh = curl_multi_init();
 
// 增加2个句柄
curl_multi_add_handle($mh,$ch1);
curl_multi_add_handle($mh,$ch2);
 
$running=null;
// 执行批处理句柄
do {
    usleep(10000);
    curl_multi_exec($mh,$running);
} while ($running &gt; 0);
 
// 关闭全部句柄
curl_multi_remove_handle($mh, $ch1);
curl_multi_remove_handle($mh, $ch2);
curl_multi_close($mh);
</code></pre>

<p>演示脚本说明了工作流程。</p>

<p>1、curl_multi_init，初始化多线程curl批处理会话。</p>

<p>2、curl_multi_add_handle，将具体执行任务的curl添加到multi_curl批处理会话。</p>

<p>3、curl_multi_exec，真正开始执行curl任务。</p>

<p>4、curl_multi_getcontent，获取执行结果。</p>

<p>5、curl_multi_remove_handle，将完成了的curl移出批处理会话。</p>

<p>6、curl_multi_close，关闭curl批处理会话。</p>

<p>mutil_curl相对于传统curl,最重要的还是理解几个概念.mutil_curl相当于一个请求线程池,这里的每一个请求都是一个单独的curl对象,跟传统的curl一样.curl_multi_add_handle方法就是往线程池里添加新的curl对象,但是并不执行.curl_multi_exec则会从线程池中拿一个curl去请求,这个时候是异步非阻塞的,所以很多请求也可以一下发出去,效率高多了.请求有返回了咋办呢,官方例子写的不好,其实有更好的方法.通过curl_multi_select方法,系统会阻塞直到有请求返回.这不就是回调通知么.而且curl_multi_select支持超时,所以非常好用.代码写出来如下:</p>

<pre><code class="language-text">&lt;?php
//bad example. 错误的例子
$start_time = microtime();
date_default_timezone_set(&#39;PRC&#39;);
 
$targets = array();//150个网址，自行添加目标
 
$total = count($targets);
echo &quot;共有{$total}个目标:\n&quot;;
 
$mh = curl_multi_init();
 
$opt = array ();
$opt[CURLOPT_HEADER] = false;
$opt[CURLOPT_CONNECTTIMEOUT] = 15;
$opt[CURLOPT_TIMEOUT] = 30;
$opt[CURLOPT_AUTOREFERER] = true;
$opt[CURLOPT_RETURNTRANSFER] = true;
$opt[CURLOPT_FOLLOWLOCATION] = true;
$opt[CURLOPT_MAXREDIRS] = 10;
 
foreach($targets as $target){
    $ch = curl_init($target);
    curl_setopt_array($ch, $opt);
    curl_multi_add_handle($mh, $ch);//要设置每个curl实例的属性
    unset($ch);
}
 
$index = 1;
do{
    do{
        curl_multi_exec($mh, $running);
        curl_multi_select($mh, 1.0);
    }while($running);
 
    while($info = curl_multi_info_read($mh)){
            $ch = $info[&#39;handle&#39;];
            $url = curl_getinfo($ch, CURLINFO_EFFECTIVE_URL);
     
    if($info[&#39;result&#39;] == CURLE_OK){
                $content = curl_multi_getcontent($ch);
                $detail = getTitle($content);
            }else
                $detail =  &#39;cURL Error(&#39; . curl_error($ch) . &quot;).&quot;;
     
    echo &quot;[$index][&quot;, date(&#39;H:i:s&#39;), &quot;]{$url}:{$detail}\n&quot;;
            $index++;
    }
 
}while($running);
 
curl_multi_close($mh);
 
function getTitle($html){
    preg_match(&quot;/&lt;title&gt;(.*)&lt;\/title&gt;/isU&quot;, $html, $title);
    return empty($title[1]) ? &#39;未能获取标题&#39; : $title[1];
}
 
echo &quot;抓取完成!\n&quot;;
$end_time = microtime();
$start_time = explode(&quot; &quot;, $start_time);
$end_time = explode(&quot; &quot;,$end_time);
$execute_time = round(($end_time[0] - $start_time[0] + $end_time[1] - $start_time[1]) * 1000) / 1000;
$execute_time = sprintf(&quot;%s&quot;, $execute_time);
echo &quot;脚本运行时间：{$execute_time} 秒\n&quot;;
</code></pre>

<p>curl_multi_select()这个方法的返回值,手册上是这样写的:</p>

<blockquote>
<p>成功时返回描述符集合中描述符的数量。失败时，select失败时返回-1，否则返回超时(从底层的select系统调用).</p>
</blockquote>

<p>但是其实curl_multi_select可能会一直返回-1,所以这时候并不是真失败了,建议写的是继续执行curl_multi_exec.所以会写在一个while循环里.注意这些问题除了受代码编写的影响，还受php和libcurl版本的影响，总而言之升级版本吧。<br/>
  至于像 CURLM_CALL_MULTI_PERFORM 之类的预定义常量，php方面并没有详细解释，多半靠看名字猜，呵呵。</p>

<p>其实这些常量是由libcurl库定义的，参考地址：<br/>
  <a href="http://curl.haxx.se/libcurl/c/libcurl-errors.html">http://curl.haxx.se/libcurl/c/libcurl-errors.html</a><br/>
  CURLM_CALL_MULTI_PERFORM (-1)</p>

<p>This is not really an error. It means you should call curl_multi_perform again without doing select() or similar in between. Before version 7.20.0 this could be returned by curl_multi_perform, but in later versions this return code is never used.<br/>
  当返回值为-1时，并不意味着这是一个错误，只是说明select时没有并没有完成excute，描述给的建议是不要执行select等阻塞操作，立即exec。<br/>
但是在libcurl的7.20版本之后，不再使用这个返回值了，原因是这个循环libcurl自己做了，就不再需要我们手动循环了。<br/>
同时注意curl_multi_select，其实还有第二个参数timeout，根据语焉不详的手册，这货应该是自带阻塞，所以就不再需要手动sleep了。</p>

<p>整个脚本的执行时间就是30秒多一点，刚好是为每个curl设置的超时时间.想了一下,这样写是每次把所有请求都发出去,相当于有多少请求就开多少线程,那如果一次搞几万请求 系统还不挂了.而且其实php并不能很好的处理这150个线程，导致很多目标获取标题失败了。</p>

<p>这就需要自己实现一个线程池，来掌控任务进度。<br/>
  思路就是用curl_multi_remove_handle一次添加n个url到multi_curl中，这个n就是线程数，这n个的组合队列就是线程池。</p>

<p>每执行完毕一个任务，就将对应的curl移除队列并销毁，同时加入新的目标，直至150个对象依次执行完毕。这样做的好处是，能保证线程池中始终有n个任务在进行，不必等这n个任务执行完毕后再执行下n个任务。<br/>
  思路有了，所以我们的代码看来是这样的：</p>

<pre><code class="language-text">&lt;?php
$start_time = microtime();
date_default_timezone_set(&#39;PRC&#39;);
 
$targets = array();//150个网址，自行添加目标
 
$total = count($targets);
 
$mh_pool = array();
$threads = 10;
$total_time = 0;
echo &quot;共有{$total}个目标:\n&quot;;
echo &quot;线程数：{$threads}\n&quot;;
 
$mh = curl_multi_init();
 
$opt = array ();
$opt[CURLOPT_HEADER] = false;
$opt[CURLOPT_CONNECTTIMEOUT] = 15;
$opt[CURLOPT_TIMEOUT] = 30;
$opt[CURLOPT_AUTOREFERER] = true;
$opt[CURLOPT_RETURNTRANSFER] = true;
$opt[CURLOPT_FOLLOWLOCATION] = true;
$opt[CURLOPT_MAXREDIRS] = 10;
 
if($total &lt; $threads)
    $threads = $total;
 
for($i=0;$i&lt;$threads;$i++){
    $task = curl_init(array_pop($targets));
    curl_setopt_array($task, $opt);
    curl_multi_add_handle($mh, $task);//要设置每个curl实例的属性
    unset($task);
}
 
$index = 1;
 
do{
    do{
        curl_multi_exec($mh, $running);
        if(curl_multi_select($mh, 1.0) &gt; 0)
            break;
    }while($running);
 
    while($info = curl_multi_info_read($mh)){
        $ch = $info[&#39;handle&#39;];
        $url = curl_getinfo($ch, CURLINFO_EFFECTIVE_URL);
        $total_time += curl_getinfo($ch, CURLINFO_TOTAL_TIME);
         
        if($info[&#39;result&#39;] == CURLE_OK){
            $content = curl_multi_getcontent($ch);
            $detail = getTitle($content);
        }else
            $detail =  &#39;cURL Error(&#39; . curl_error($ch) . &quot;).&quot;;
         
        echo &quot;[$index][&quot;, date(&#39;H:i:s&#39;), &quot;]{$url}:{$detail}\n&quot;;
        $index++;
         
        curl_multi_remove_handle($mh, $ch);
        curl_close($ch);
        unset($ch);
         
        if($targets){
            $new_task = curl_init(array_pop($targets));
            curl_setopt_array($new_task, $opt);
            curl_multi_add_handle($mh, $new_task);//要设置每个curl实例的属性
        }
    }
 
}while($running);
 
curl_multi_close($mh);
 
function getTitle($html){
    preg_match(&quot;/&lt;title&gt;(.*)&lt;\/title&gt;/isU&quot;, $html, $title);
    return empty($title[1]) ? &#39;未能获取标题&#39; : $title[1];
}
 
echo &quot;抓取完成!\n&quot;;
$end_time = microtime();
$start_time = explode(&quot; &quot;, $start_time);
$end_time = explode(&quot; &quot;, $end_time);
$execute_time = round(($end_time[0] - $start_time[0] + $end_time[1] - $start_time[1]) * 1000) / 1000;
$execute_time = sprintf(&quot;%s&quot;, $execute_time);
echo &quot;http请求时间：{$total_time} 秒\n&quot;;
echo &quot;脚本运行时间：{$execute_time} 秒\n&quot;;
</code></pre>

<p>为了细化处理多线程curl每个请求的执行结果，我在curl_multi_select的返回值大于0的时候也跳出了当前exec循环，并通过curl_multi_info_read来获取已经完成的任务信息。这里封装下就可以做个回调，精细化处理每个任务。</p>

<p>另一个地方就是注意curl_multi_info_read需要多次调用。这个函数每次调用返回已经完成的任务信息，直至没有已完成的任务。问题4产生的原因就是因为我当时用了if没用while，这是一个小坑，但坑了我相当长的时间。当时非常无奈的解决方式是监控了整个执行过程，在所有任务完成后清点队列，把遗漏的再取出来。。。</p>

<p>这样搞之后,发现几百个请求已经很ok了,公司网络不是很好,请求1000次百度大概要几十秒.而且同时开起的$threads进程数量也不是越多越好,根据网络和CPU核数自己测试估计能取得个平衡.把请求队列扩大,搞到5000次,发现问题来了.</p>

<p>5000次请求,基本只有1500-1800次能成功,这肯定是有问题了.然而跟超时时间并没有关系.在每个环节打了log发现,在任务结束的时候$targets并没有全部pop出去.也就是说,剩下的请求根本就没发.这特么,是有错误还是停止条件的问题?</p>

<p>通过log记录每个请求之后的\(running值,也就是停止条件,发现\)running确实是变成0了,所以会退出循环.这个$running是这样来的:</p>

<blockquote>
<p>curl_multi_exec(\(mh, \)running);</p>
</blockquote>

<p>手册写的是:</p>

<pre><code class="language-text">int curl_multi_exec ( resource $mh , int &amp;$still_running )
处理在栈中的每一个句柄。无论该句柄需要读取或写入数据都可调用此方法。

参数
mh              由 curl_multi_init() 返回的 cURL 多个句柄。
still_running   一个用来判断操作是否仍在执行的标识的引用。
</code></pre>

<p>这特么说了没说一样啊.谁知道是啥意思. 通过log不断的观察,发现这个值,表示的是 &quot;正在进行中的线程数量&quot;,也就是当前有多少请求正在执行.然后就发现,这个值并不是每次都会减少1...有时候会有多个请求一起返回了,所以会减少多个.但是每次往池子里添加的新请求都是1,这样肯定越来越少了,最后$running就变成0了,但是请求任务还没有完...<br/>
  最终写了一个class,凑合撸吧.这样基本没问题了.</p>

<pre><code class="language-text">&lt;?php 
/*
 * Multi curl in PHP 
 * @author  rainyluo 
 * @date    2016-04-15
 */
class MultiCurl {
    //urls needs to be fetched 
    public $targets = array();
    //parallel running curl threads 
    public $threads = 10;
    //curl options 
    public $curlOpt = array();
    //callback function 
    public $callback = null;
    //debug ,will show log using echo 
    public $debug = true;
    
    //multi curl handler
    private $mh = null;
    //curl running signal 
    private $runningSig = null;


    public function __construct() {
        $this-&gt;mh = curl_multi_init();
        $this-&gt;curlOpt             = array(
            CURLOPT_HEADER         =&gt; false,
            CURLOPT_CONNECTTIMEOUT =&gt; 10,
            CURLOPT_TIMEOUT        =&gt; 10,
            CURLOPT_AUTOREFERER    =&gt; true,
            CURLOPT_RETURNTRANSFER =&gt; true,
            CURLOPT_FOLLOWLOCATION =&gt; true,
            CURLOPT_MAXREDIRS      =&gt; 5,
        );
        $this-&gt;callback = function($html) {
            echo md5($html);
            echo &quot;fetched&quot;; 
            echo &quot;\r\n&quot;;
        };
    }

    public function setTargets($urls) {
        $this-&gt;targets = $urls;
        return $this;
    }
    public function setThreads($threads) {
        $this-&gt;threads = intval($threads);
        return $this;
    }
    public function setCallback($func) {
        $this-&gt;callback = $func;
        return $this;
    }
    /* 
     * start running 
     */
    public function run() {
        $this-&gt;initPool();
        $this-&gt;runCurl(); 
    }

    /*
     * run multi curl 
     */
    private function runCurl() {
        do{
            //start request thread and wait for return,if there&#39;s no return in 1s,continue add request thread 
            do{
                curl_multi_exec($this-&gt;mh, $this-&gt;runningSig);
                $this-&gt;log(&quot;exec results...running sig is&quot;.$this-&gt;runningSig);
                $return = curl_multi_select($this-&gt;mh, 1.0);
                if($return &gt; 0){
                    $this-&gt;log(&quot;there is a return...$return&quot;);
                    break;
                }
                unset($return);
            } while ($this-&gt;runningSig&gt;0);

            //if there is return,read it 
            while($returnInfo = curl_multi_info_read($this-&gt;mh)) {
                $handler = $returnInfo[&quot;handle&quot;];
                if($returnInfo[&quot;result&quot;] == CURLE_OK) {
                    $url = curl_getinfo($handler, CURLINFO_EFFECTIVE_URL);
                    $this-&gt;log($url.&quot;returns data&quot;);
                    $callback = $this-&gt;callback;
                    $callback(curl_multi_getcontent($handler));
                } else {
                    $url = curl_getinfo($handler, CURLINFO_EFFECTIVE_URL);
                    $this-&gt;log(&quot;$url fetch error.&quot;.curl_error($handler));
                }
                curl_multi_remove_handle($this-&gt;mh, $handler);
                curl_close($handler);
                unset($handler);
                //add new targets into curl thread 
                if($this-&gt;targets) {
                    $threadsIdel = $this-&gt;threads - $this-&gt;runningSig;
                    $this-&gt;log(&quot;idel threads:&quot;.$threadsIdel);
                    if($threadsIdel &lt; 0) continue;
                    for($i=0;$i&lt;$threadsIdel;$i++) {
                        $t = array_pop($this-&gt;targets);
                        if(!$t) continue;
                        $task = curl_init($t);
                        curl_setopt_array($task, $this-&gt;curlOpt);
                        curl_multi_add_handle($this-&gt;mh, $task);
                        $this-&gt;log(&quot;new task adds!&quot;.$task);
                        $this-&gt;runningSig += 1;
                        unset($task);
                    }

                } else {
                    $this-&gt;log(&quot;targets all finished&quot;);
                }
            }
        }while($this-&gt;runningSig);
    }

    /*
     * init multi curl pool
     */
    private function initPool() {
        if(count($this-&gt;targets) &lt; $this-&gt;threads) $this-&gt;threads = count($this-&gt;targets);
        //init curl handler pool ...
        for($i=1;$i&lt;=$this-&gt;threads;$i++) {
            $task = curl_init(array_pop($this-&gt;targets));
            curl_setopt_array($task, $this-&gt;curlOpt);
            curl_multi_add_handle($this-&gt;mh, $task);
            $this-&gt;log(&quot;init pool thread one&quot;);
            unset($task);
        }
        $this-&gt;log(&quot;init pool done&quot;);
    }

    private function log($log) {
        if(!$this-&gt;debug) return false;
        ob_start();
        echo &quot;---------- &quot;.date(&quot;Y-m-d H:i&quot;,time()).&quot;-------------&quot;;
        if(is_array($log)) {
            echo json_encode($log);
        } else {
            echo $log;
        }
        $m = memory_get_usage();
        echo &quot;memory:&quot;.intval($m/1024).&quot;kb\r\n&quot;;
        echo &quot;\r\n&quot;;
        flush();
        ob_end_flush();
        unset($log);
    }
    public function __destruct(){
        $this-&gt;log(&quot;curl ends.&quot;);
        curl_multi_close($this-&gt;mh);
    }
    

}
</code></pre>

<p>用法:</p>

<pre><code class="language-text">$mu = new MultiCurl();
$callback = function($html) {
    var_dump($html);
};
$mu-&gt;setTargets($urls)-&gt;setCallback($callback)-&gt;setThreads(5)-&gt;run();
</code></pre>

<p>PS:一个插曲<br/>
  代码写的差不多的时候发现,每次请求快到2k的时候就崩溃了,报segmentation fault.这不坑爹呢么,上GDB看Coredump,捣鼓半天发现应该是跟内存回收有关系,找了半天也没有相关的解决方案,迷迷糊糊的.想想还是老路子,打log吧.每一步的内存都打出来,发现内存占用越来越多啊,每次请求要十几k的往上涨,最后一百多M了就挂了.这有问题啊,肯定有啥没释放的地方.把不用的变量都unset掉,猛然发现少了curl_multi_remove_handle(\(this-&gt;mh, \)handler);跟curl_close($handler) 这不坑爹呢么...链接忘了close,肯定不是释放了啊.终归还是对curl_mutil的内部不是很熟悉.估计里面的每个curl对象都是独立的,只有close之后才会被回收释放吧.改好之后,10个threads一起跑,基本上内存占用十几m不到,5k的请求也一会搞定了.妈蛋,充实的一天 自己给自己挖坑啊.</p>


</div>

<br /><br />
<hr />

<div class="row clearfix">
  <div class="large-6 columns">
	<div class="text-left" style="padding:15px 0px;">
		
	        <a href="15923063084891.html"  title="Previous Post: 2018-08-01反思">&laquo; 2018-08-01反思</a>
	    
	</div>
  </div>
  <div class="large-6 columns">
	<div class="text-right" style="padding:15px 0px;">
		
	        <a href="15923063085495.html" 
	        title="Next Post: 用PHP-CLI在SHELL中输出颜色">用PHP-CLI在SHELL中输出颜色 &raquo;</a>
	    
	</div>
  </div>
</div>

<div class="row">
<div style="padding:0px 0.93em;" class="share-comments">

</div>
</div>
<script type="text/javascript">
	$(function(){
		var currentURL = '15923063085282.html';
		$('#side-nav a').each(function(){
			if($(this).attr('href') == currentURL){
				$(this).parent().addClass('active');
			}
		});
	});
</script>  
</div></div>


<div class="page-bottom">
  <div class="row">
  <hr />
  <div class="small-9 columns">
  <p class="copyright">Copyright &copy; 2020
备案信息: <a target="_blank" href="http://www.mweb.im">京ICP备14056617号</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
  <div class="small-3 columns">
  <p class="copyright text-right"><a href="#header">TOP</a></p>
  </div>
   
  </div>
</div>

        </section>
      </div>
    </div>
    
    
    <script src="asset/js/foundation.min.js"></script>
    <script src="asset/js/foundation/foundation.offcanvas.js"></script>
    <script>
      $(document).foundation();

     
    </script>
    


  </body>
</html>
