<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  gopush代码分析-comet模块 - Rainyluo's BLOG
  
  </title>
 <meta name="description" content="">
 <link href="atom.xml" rel="alternate" title="Rainyluo's BLOG" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />

    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
    <script src="asset/highlightjs/highlight.pack.js"></script>
    <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
    <script>hljs.initHighlightingOnLoad();</script>
    
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>

<div id="header">
    <h1><a href="index.html">Rainyluo's BLOG</a></h1>
</div>

</nav>
        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; Rainyluo's BLOG</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
      <li><a href="index.html">Home</a></li>
      
        <li class="divider"></li>
        <li><label>Hyperf</label></li>

          
            <li><a title="# Hyperf源码阅读 第二章 HTTP服务初始化" href="15932480961729.html"># Hyperf源码阅读 第二章 HTTP服务初始化</a></li>
          
            <li><a title="Hyperf源码阅读 第一章 初始化" href="15928236190986.html">Hyperf源码阅读 第一章 初始化</a></li>
          

      
        <li class="divider"></li>
        <li><label>随感</label></li>

          
            <li><a title="如何变得平庸" href="15923063082122.html">如何变得平庸</a></li>
          
            <li><a title="一个实用主义者的反思" href="15923063082072.html">一个实用主义者的反思</a></li>
          
            <li><a title="2018-08-01 感想" href="15923063081475.html">2018-08-01 感想</a></li>
          
            <li><a title="2019的成长" href="15923063084995.html">2019的成长</a></li>
          
            <li><a title="细节与功利主义：致那些同我一样想突破自己技术层级的朋友们" href="15771974682027.html">细节与功利主义：致那些同我一样想突破自己技术层级的朋友们</a></li>
          
            <li><a title="审美是一切美好追求的基础" href="15706010504336.html">审美是一切美好追求的基础</a></li>
          
            <li><a title="什么叫"回归初心" 以及技术成长突破的心态" href="15696591889118.html">什么叫"回归初心" 以及技术成长突破的心态</a></li>
          

      
        <li class="divider"></li>
        <li><label>其他</label></li>

          
            <li><a title="理解矩阵" href="15936798966495.html">理解矩阵</a></li>
          
            <li><a title="cocopods重装解决framework not found Pods/no such module" href="15923063082414.html">cocopods重装解决framework not found Pods/no such module</a></li>
          
            <li><a title="pts导入bts2.0教程" href="15923063083603.html">pts导入bts2.0教程</a></li>
          
            <li><a title="gopush代码分析-comet模块" href="15923063083769.html">gopush代码分析-comet模块</a></li>
          
            <li><a title="Chrome Extension扩展开发之复制粘贴" href="15923063083833.html">Chrome Extension扩展开发之复制粘贴</a></li>
          
            <li><a title="iowait详解" href="15923063084125.html">iowait详解</a></li>
          
            <li><a title="mac安装mysql-python(with XAMPP)" href="15923063084788.html">mac安装mysql-python(with XAMPP)</a></li>
          
            <li><a title="App内使用H5页面的一个安全问题" href="15923063086512.html">App内使用H5页面的一个安全问题</a></li>
          
            <li><a title="PHP 通过Apns给Ios设备推送Notification" href="15923063086602.html">PHP 通过Apns给Ios设备推送Notification</a></li>
          
            <li><a title="python中使用import加载目录中全部文件" href="15923063087292.html">python中使用import加载目录中全部文件</a></li>
          
            <li><a title="kvm/virsh 异常断电导致虚拟机无法启动的修复实战" href="15923063088164.html">kvm/virsh 异常断电导致虚拟机无法启动的修复实战</a></li>
          
            <li><a title="Synology office error: User home service is not enabled" href="15923063081281.html">Synology office error: User home service is not enabled</a></li>
          
            <li><a title="git commit后自动检查php文件语法" href="15923063081235.html">git commit后自动检查php文件语法</a></li>
          
            <li><a title="梅林固件/R6300V2 安装Lcd4Linux显示屏" href="15923063081215.html">梅林固件/R6300V2 安装Lcd4Linux显示屏</a></li>
          

      
        <li class="divider"></li>
        <li><label>About</label></li>

          
            <li><a title="Rainyluo's Blog" href="15923063081658.html">Rainyluo's Blog</a></li>
          

      
        <li class="divider"></li>
        <li><label>PHP</label></li>

          
            <li><a title="二维数组排序 array multisort" href="15756185241314.html">二维数组排序 array multisort</a></li>
          
            <li><a title="PHP中的闭包理解" href="15931630289738.html">PHP中的闭包理解</a></li>
          
            <li><a title="reactPHP + lumen性能简测" href="15923063083212.html">reactPHP + lumen性能简测</a></li>
          
            <li><a title="QueryPath中文乱码问题,UTF8乱码问题解决" href="15923063084242.html">QueryPath中文乱码问题,UTF8乱码问题解决</a></li>
          
            <li><a title="WorkerMan的restart命令的一个Bug修复记录" href="15923063084445.html">WorkerMan的restart命令的一个Bug修复记录</a></li>
          
            <li><a title="PHP的多线程Curl,rolling Curl实现与坑" href="15923063085282.html">PHP的多线程Curl,rolling Curl实现与坑</a></li>
          
            <li><a title="用PHP-CLI在SHELL中输出颜色" href="15923063085495.html">用PHP-CLI在SHELL中输出颜色</a></li>
          
            <li><a title="使用GITHUB+JustWriting搭建BLOG" href="15923063087852.html">使用GITHUB+JustWriting搭建BLOG</a></li>
          
            <li><a title="[原创翻译]QueryPath PHP的Jquery实现,QueryPath教程" href="15923063087972.html">[原创翻译]QueryPath PHP的Jquery实现,QueryPath教程</a></li>
          
            <li><a title="(伪)异步实现加速PHP接口的返回速度" href="15923063089153.html">(伪)异步实现加速PHP接口的返回速度</a></li>
          
            <li><a title="PHP调试技巧" href="15922725010749.html">PHP调试技巧</a></li>
          

      
      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>

        <section id="main-content" role="main" class="scroll-container">

          <div class="row">
            <div class="large-3 medium-3 columns">
              <div class="hide-for-small">
                <div class="sidebar">
                <nav>
                  <ul id="side-nav" class="side-nav">

                    
                      <li class="side-title"><span>Hyperf</span></li>
                        
                          <li><a title="# Hyperf源码阅读 第二章 HTTP服务初始化" href="15932480961729.html"># Hyperf源码阅读 第二章 HTTP服务初始化</a></li>
                        
                          <li><a title="Hyperf源码阅读 第一章 初始化" href="15928236190986.html">Hyperf源码阅读 第一章 初始化</a></li>
                        

                    
                      <li class="side-title"><span>随感</span></li>
                        
                          <li><a title="如何变得平庸" href="15923063082122.html">如何变得平庸</a></li>
                        
                          <li><a title="一个实用主义者的反思" href="15923063082072.html">一个实用主义者的反思</a></li>
                        
                          <li><a title="2018-08-01 感想" href="15923063081475.html">2018-08-01 感想</a></li>
                        
                          <li><a title="2019的成长" href="15923063084995.html">2019的成长</a></li>
                        
                          <li><a title="细节与功利主义：致那些同我一样想突破自己技术层级的朋友们" href="15771974682027.html">细节与功利主义：致那些同我一样想突破自己技术层级的朋友们</a></li>
                        
                          <li><a title="审美是一切美好追求的基础" href="15706010504336.html">审美是一切美好追求的基础</a></li>
                        
                          <li><a title="什么叫"回归初心" 以及技术成长突破的心态" href="15696591889118.html">什么叫"回归初心" 以及技术成长突破的心态</a></li>
                        

                    
                      <li class="side-title"><span>其他</span></li>
                        
                          <li><a title="理解矩阵" href="15936798966495.html">理解矩阵</a></li>
                        
                          <li><a title="cocopods重装解决framework not found Pods/no such module" href="15923063082414.html">cocopods重装解决framework not found Pods/no such module</a></li>
                        
                          <li><a title="pts导入bts2.0教程" href="15923063083603.html">pts导入bts2.0教程</a></li>
                        
                          <li><a title="gopush代码分析-comet模块" href="15923063083769.html">gopush代码分析-comet模块</a></li>
                        
                          <li><a title="Chrome Extension扩展开发之复制粘贴" href="15923063083833.html">Chrome Extension扩展开发之复制粘贴</a></li>
                        
                          <li><a title="iowait详解" href="15923063084125.html">iowait详解</a></li>
                        
                          <li><a title="mac安装mysql-python(with XAMPP)" href="15923063084788.html">mac安装mysql-python(with XAMPP)</a></li>
                        
                          <li><a title="App内使用H5页面的一个安全问题" href="15923063086512.html">App内使用H5页面的一个安全问题</a></li>
                        
                          <li><a title="PHP 通过Apns给Ios设备推送Notification" href="15923063086602.html">PHP 通过Apns给Ios设备推送Notification</a></li>
                        
                          <li><a title="python中使用import加载目录中全部文件" href="15923063087292.html">python中使用import加载目录中全部文件</a></li>
                        
                          <li><a title="kvm/virsh 异常断电导致虚拟机无法启动的修复实战" href="15923063088164.html">kvm/virsh 异常断电导致虚拟机无法启动的修复实战</a></li>
                        
                          <li><a title="Synology office error: User home service is not enabled" href="15923063081281.html">Synology office error: User home service is not enabled</a></li>
                        
                          <li><a title="git commit后自动检查php文件语法" href="15923063081235.html">git commit后自动检查php文件语法</a></li>
                        
                          <li><a title="梅林固件/R6300V2 安装Lcd4Linux显示屏" href="15923063081215.html">梅林固件/R6300V2 安装Lcd4Linux显示屏</a></li>
                        

                    
                      <li class="side-title"><span>About</span></li>
                        
                          <li><a title="Rainyluo's Blog" href="15923063081658.html">Rainyluo's Blog</a></li>
                        

                    
                      <li class="side-title"><span>PHP</span></li>
                        
                          <li><a title="二维数组排序 array multisort" href="15756185241314.html">二维数组排序 array multisort</a></li>
                        
                          <li><a title="PHP中的闭包理解" href="15931630289738.html">PHP中的闭包理解</a></li>
                        
                          <li><a title="reactPHP + lumen性能简测" href="15923063083212.html">reactPHP + lumen性能简测</a></li>
                        
                          <li><a title="QueryPath中文乱码问题,UTF8乱码问题解决" href="15923063084242.html">QueryPath中文乱码问题,UTF8乱码问题解决</a></li>
                        
                          <li><a title="WorkerMan的restart命令的一个Bug修复记录" href="15923063084445.html">WorkerMan的restart命令的一个Bug修复记录</a></li>
                        
                          <li><a title="PHP的多线程Curl,rolling Curl实现与坑" href="15923063085282.html">PHP的多线程Curl,rolling Curl实现与坑</a></li>
                        
                          <li><a title="用PHP-CLI在SHELL中输出颜色" href="15923063085495.html">用PHP-CLI在SHELL中输出颜色</a></li>
                        
                          <li><a title="使用GITHUB+JustWriting搭建BLOG" href="15923063087852.html">使用GITHUB+JustWriting搭建BLOG</a></li>
                        
                          <li><a title="[原创翻译]QueryPath PHP的Jquery实现,QueryPath教程" href="15923063087972.html">[原创翻译]QueryPath PHP的Jquery实现,QueryPath教程</a></li>
                        
                          <li><a title="(伪)异步实现加速PHP接口的返回速度" href="15923063089153.html">(伪)异步实现加速PHP接口的返回速度</a></li>
                        
                          <li><a title="PHP调试技巧" href="15922725010749.html">PHP调试技巧</a></li>
                        

                    
                  </ul>
                </nav>
                </div>
              </div>
            </div>
            <div class="large-9 medium-9 columns">

 <div class="markdown-body">
<h1>gopush代码分析-comet模块</h1>

<p>Tags:  go 推送 <br/>
Toc:no<br/>
Status: public<br/>
Position: 1</p>

<p>=<mark>Comet模块</mark>=</p>

<blockquote>
<p>负责SOCKET连接处理,支持TCP SOCKET与WEBSOCKET两种协议,数据传输采用REDIS的序列化协议</p>
</blockquote>

<p>main启动后,初始化如下<br/>
InitConfig()<br/>
perf.Init(Conf.PprofBind)<br/>
NewChannelList()<br/>
StartStats()<br/>
StartRPC()<br/>
StartComet()<br/>
InitZK()<br/>
InitSignal()</p>

<p>其中,NewChannelList()根据 Conf.ChannelBucket指定的数量,初始化一定量的 &amp;ChannelBucket对象,并把这些bucket加入到&amp;ChannelList中.整个ChannelList的结构很简单:</p>

<pre><code class="language-text">type ChannelList struct {
    Channels []*ChannelBucket
}
</code></pre>

<p>Bucket可以理解为一个池,初始化好这个池后,每一个新进来的链接,都会根据MruMruHash算法,把SeqChannel平均分配加入到Bucket这个池子中,这个后面会讲到.</p>

<p>先从主体开始说起吧,StartComet()当然是主要的了,根据配置里的proto协议,分别或者全部启动TCP与WEBSOCKET监听,此处拿TCP监听为例.StartTCP()后,根据Conf.TCPBind的配置,启动多个TCP监听routine:</p>

<pre><code class="language-text">go tcpListen(bind)
</code></pre>

<p>开始Listen后,在for循环中不停的开始Accept,并且设置了TCP相应的参数,每个新进入的连接,开启一个新的routine处理:</p>

<pre><code class="language-text">for{
    conn.SetKeepAlive(Conf.TCPKeepalive)
    conn.SetReadBuffer(Conf.RcvbufSize)
    conn.SetWriteBuffer(Conf.SndbufSize)
    conn.SetReadDeadline(time.Now().Add(fitstPacketTimedoutSec))
    go handleTCPConn(conn, rc)
}
</code></pre>

<p>进入处理SOCKET数据的阶段了,BufIoReader读取SOCKET的数据,解析参数 </p>

<pre><code class="language-text">parseCmd(rd)
</code></pre>

<p>值得一说的是GoPush采用的(REDIS的协议)[<a href="http://redis.io/topics/protocol%5D,%E8%BF%99%E7%AF%87%E8%AF%B4%E6%98%8E%E5%86%99%E7%9A%84%E5%BE%88%E8%AF%A6%E7%BB%86%E4%BA%86.%E5%B0%B1%E6%98%AF%E4%B8%80%E4%B8%AA%E7%B1%BB%E4%BC%BCJSON%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E5%8D%8F%E8%AE%AE,%E6%94%AF%E6%8C%81%E6%95%B0%E7%BB%84/%E5%AD%97%E7%AC%A6%E4%B8%B2/%E6%95%B0%E5%AD%97/%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF/%E5%87%A0%E7%A7%8D%E7%AE%80%E5%8D%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%9A%84%E4%BC%A0%E9%80%92,%E6%AF%94%E8%BE%83%E5%8F%8B%E5%A5%BD%E6%98%8E%E6%96%87%E5%8F%AF%E8%AF%BB,%E5%B9%B6%E4%B8%94%E8%A7%A3%E6%9E%90%E6%95%88%E7%8E%87%E9%AB%98,%E5%A0%AA%E6%AF%942%E8%BF%9B%E5%88%B6%7E">http://redis.io/topics/protocol],这篇说明写的很详细了.就是一个类似JSON的序列化协议,支持数组/字符串/数字/错误信息/几种简单数据结构的传递,比较友好明文可读,并且解析效率高,堪比2进制~</a></p>

<p>args[0]代表命令,默认必须是sub,否则报错.这块的逻辑跟Redis的PUB/SUB模型比较类似,都是Client订阅某个Channel,然后等待消息推送过来.<br/>
接下来对args中的几个参数,key/heartbeat/token/version进行判断,然后新建一个用于通讯的channel:</p>

<pre><code class="language-text">UserChannel.Get(key, true)
</code></pre>

<p>这个UserChannel.Get()方法又做了一些事 比较复杂.之前在初始化的时候,新建了一个ChannelList,里面保存了一组初始化好的Bucket,用来做Channel的池.Get方法,先验证一下Client需要Sub的Key是不是属于这个Comet节点的:</p>

<pre><code class="language-text">node := CometRing.Hash(key)
if Conf.ZookeeperCometNode != node {
    log.Warn(&quot;user_key:\&quot;%s\&quot; node:%s not match this node:%s&quot;, key, node, Conf.ZookeeperCometNode)
    return ErrChannelKey
}

</code></pre>

<p>CometRing.Hash 就是采用ketama(ketama:libketama-style consistent hashing in Go)的一致性哈希算法,<a href="https://github.com/mncaudill/ketama">ketama项目地址</a><br/>
验证通过后,从ChannelList的Bucket中,获取这个Key对应的SeqChannel,如果没有则新建</p>

<pre><code class="language-text">b := l.Bucket(key)
if c, ok := b.Data[key]; !ok {
    if !Conf.Auth &amp;&amp; newOne {
        c = NewSeqChannel()
        b.Data[key] = c
        ...
        return c, nil
    } else {
      ...       
    }
} else {
    ...
    return c, nil
}
</code></pre>

<p>SeqChannel是外部与Client沟通的通道,比如从Web发过来的消息,通过RPC传给Comet模块,在通过SeqChannel发给Client,另外还有Token验证的功能,比较简单一看就好了</p>

<p>接下来就是在这个routine中持续监听Socket数据流并发送心跳了,如果产生错误就break并删除SeqChannel.</p>

<pre><code class="language-text">for {
    conn.SetReadDeadline(time.Now().Add(time.Second * time.Duration(heartbeat)))
    conn.Read(reply)    
    if string(reply) == Heartbeat {
        ...
        conn.Write(HeartbeatReply) //服务器发来心跳,并写一个心跳回去
    }
    end = time.Now().UnixNano() //更新SOCKET超时时间
}
</code></pre>

<blockquote>
<p>到此,主要的Socket监听/通讯/心跳就完成了.</p>
</blockquote>


</div>

<br /><br />
<hr />

<div class="row clearfix">
  <div class="large-6 columns">
	<div class="text-left" style="padding:15px 0px;">
		
	        <a href="15923063083603.html"  title="Previous Post: pts导入bts2.0教程">&laquo; pts导入bts2.0教程</a>
	    
	</div>
  </div>
  <div class="large-6 columns">
	<div class="text-right" style="padding:15px 0px;">
		
	        <a href="15923063083833.html" 
	        title="Next Post: Chrome Extension扩展开发之复制粘贴">Chrome Extension扩展开发之复制粘贴 &raquo;</a>
	    
	</div>
  </div>
</div>

<div class="row">
<div style="padding:0px 0.93em;" class="share-comments">

</div>
</div>
<script type="text/javascript">
	$(function(){
		var currentURL = '15923063083769.html';
		$('#side-nav a').each(function(){
			if($(this).attr('href') == currentURL){
				$(this).parent().addClass('active');
			}
		});
	});
</script>  
</div></div>


<div class="page-bottom">
  <div class="row">
  <hr />
  <div class="small-9 columns">
  <p class="copyright">Copyright &copy; 2020
备案信息: <a target="_blank" href="http://www.mweb.im">京ICP备14056617号</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
  <div class="small-3 columns">
  <p class="copyright text-right"><a href="#header">TOP</a></p>
  </div>
   
  </div>
</div>

        </section>
      </div>
    </div>
    
    
    <script src="asset/js/foundation.min.js"></script>
    <script src="asset/js/foundation/foundation.offcanvas.js"></script>
    <script>
      $(document).foundation();

     
    </script>
    


  </body>
</html>
