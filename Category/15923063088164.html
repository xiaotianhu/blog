<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  kvm/virsh 异常断电导致虚拟机无法启动的修复实战 - Rainyluo's BLOG
  
  </title>
 <meta name="description" content="">
 <link href="atom.xml" rel="alternate" title="Rainyluo's BLOG" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />

    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
    <script src="asset/highlightjs/highlight.pack.js"></script>
    <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
    <script>hljs.initHighlightingOnLoad();</script>
    
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>

<div id="header">
    <h1><a href="index.html">Rainyluo's BLOG</a></h1>
</div>

</nav>
        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; Rainyluo's BLOG</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
      <li><a href="index.html">Home</a></li>
      
        <li class="divider"></li>
        <li><label>Hyperf</label></li>

          
            <li><a title="# Hyperf源码阅读 第二章 HTTP服务初始化" href="15932480961729.html"># Hyperf源码阅读 第二章 HTTP服务初始化</a></li>
          
            <li><a title="Hyperf源码阅读 第一章 初始化" href="15928236190986.html">Hyperf源码阅读 第一章 初始化</a></li>
          

      
        <li class="divider"></li>
        <li><label>随感</label></li>

          
            <li><a title="如何变得平庸" href="15923063082122.html">如何变得平庸</a></li>
          
            <li><a title="一个实用主义者的反思" href="15923063082072.html">一个实用主义者的反思</a></li>
          
            <li><a title="2018-08-01 感想" href="15923063081475.html">2018-08-01 感想</a></li>
          
            <li><a title="2019的成长" href="15923063084995.html">2019的成长</a></li>
          
            <li><a title="细节与功利主义：致那些同我一样想突破自己技术层级的朋友们" href="15771974682027.html">细节与功利主义：致那些同我一样想突破自己技术层级的朋友们</a></li>
          
            <li><a title="审美是一切美好追求的基础" href="15706010504336.html">审美是一切美好追求的基础</a></li>
          
            <li><a title="什么叫"回归初心" 以及技术成长突破的心态" href="15696591889118.html">什么叫"回归初心" 以及技术成长突破的心态</a></li>
          

      
        <li class="divider"></li>
        <li><label>其他</label></li>

          
            <li><a title="理解矩阵" href="15936798966495.html">理解矩阵</a></li>
          
            <li><a title="cocopods重装解决framework not found Pods/no such module" href="15923063082414.html">cocopods重装解决framework not found Pods/no such module</a></li>
          
            <li><a title="pts导入bts2.0教程" href="15923063083603.html">pts导入bts2.0教程</a></li>
          
            <li><a title="gopush代码分析-comet模块" href="15923063083769.html">gopush代码分析-comet模块</a></li>
          
            <li><a title="Chrome Extension扩展开发之复制粘贴" href="15923063083833.html">Chrome Extension扩展开发之复制粘贴</a></li>
          
            <li><a title="iowait详解" href="15923063084125.html">iowait详解</a></li>
          
            <li><a title="mac安装mysql-python(with XAMPP)" href="15923063084788.html">mac安装mysql-python(with XAMPP)</a></li>
          
            <li><a title="App内使用H5页面的一个安全问题" href="15923063086512.html">App内使用H5页面的一个安全问题</a></li>
          
            <li><a title="PHP 通过Apns给Ios设备推送Notification" href="15923063086602.html">PHP 通过Apns给Ios设备推送Notification</a></li>
          
            <li><a title="python中使用import加载目录中全部文件" href="15923063087292.html">python中使用import加载目录中全部文件</a></li>
          
            <li><a title="kvm/virsh 异常断电导致虚拟机无法启动的修复实战" href="15923063088164.html">kvm/virsh 异常断电导致虚拟机无法启动的修复实战</a></li>
          
            <li><a title="Synology office error: User home service is not enabled" href="15923063081281.html">Synology office error: User home service is not enabled</a></li>
          
            <li><a title="git commit后自动检查php文件语法" href="15923063081235.html">git commit后自动检查php文件语法</a></li>
          
            <li><a title="梅林固件/R6300V2 安装Lcd4Linux显示屏" href="15923063081215.html">梅林固件/R6300V2 安装Lcd4Linux显示屏</a></li>
          

      
        <li class="divider"></li>
        <li><label>About</label></li>

          
            <li><a title="Rainyluo's Blog" href="15923063081658.html">Rainyluo's Blog</a></li>
          

      
        <li class="divider"></li>
        <li><label>PHP</label></li>

          
            <li><a title="二维数组排序 array multisort" href="15756185241314.html">二维数组排序 array multisort</a></li>
          
            <li><a title="PHP中的闭包理解" href="15931630289738.html">PHP中的闭包理解</a></li>
          
            <li><a title="reactPHP + lumen性能简测" href="15923063083212.html">reactPHP + lumen性能简测</a></li>
          
            <li><a title="QueryPath中文乱码问题,UTF8乱码问题解决" href="15923063084242.html">QueryPath中文乱码问题,UTF8乱码问题解决</a></li>
          
            <li><a title="WorkerMan的restart命令的一个Bug修复记录" href="15923063084445.html">WorkerMan的restart命令的一个Bug修复记录</a></li>
          
            <li><a title="PHP的多线程Curl,rolling Curl实现与坑" href="15923063085282.html">PHP的多线程Curl,rolling Curl实现与坑</a></li>
          
            <li><a title="用PHP-CLI在SHELL中输出颜色" href="15923063085495.html">用PHP-CLI在SHELL中输出颜色</a></li>
          
            <li><a title="使用GITHUB+JustWriting搭建BLOG" href="15923063087852.html">使用GITHUB+JustWriting搭建BLOG</a></li>
          
            <li><a title="[原创翻译]QueryPath PHP的Jquery实现,QueryPath教程" href="15923063087972.html">[原创翻译]QueryPath PHP的Jquery实现,QueryPath教程</a></li>
          
            <li><a title="(伪)异步实现加速PHP接口的返回速度" href="15923063089153.html">(伪)异步实现加速PHP接口的返回速度</a></li>
          
            <li><a title="PHP调试技巧" href="15922725010749.html">PHP调试技巧</a></li>
          

      
      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>

        <section id="main-content" role="main" class="scroll-container">

          <div class="row">
            <div class="large-3 medium-3 columns">
              <div class="hide-for-small">
                <div class="sidebar">
                <nav>
                  <ul id="side-nav" class="side-nav">

                    
                      <li class="side-title"><span>Hyperf</span></li>
                        
                          <li><a title="# Hyperf源码阅读 第二章 HTTP服务初始化" href="15932480961729.html"># Hyperf源码阅读 第二章 HTTP服务初始化</a></li>
                        
                          <li><a title="Hyperf源码阅读 第一章 初始化" href="15928236190986.html">Hyperf源码阅读 第一章 初始化</a></li>
                        

                    
                      <li class="side-title"><span>随感</span></li>
                        
                          <li><a title="如何变得平庸" href="15923063082122.html">如何变得平庸</a></li>
                        
                          <li><a title="一个实用主义者的反思" href="15923063082072.html">一个实用主义者的反思</a></li>
                        
                          <li><a title="2018-08-01 感想" href="15923063081475.html">2018-08-01 感想</a></li>
                        
                          <li><a title="2019的成长" href="15923063084995.html">2019的成长</a></li>
                        
                          <li><a title="细节与功利主义：致那些同我一样想突破自己技术层级的朋友们" href="15771974682027.html">细节与功利主义：致那些同我一样想突破自己技术层级的朋友们</a></li>
                        
                          <li><a title="审美是一切美好追求的基础" href="15706010504336.html">审美是一切美好追求的基础</a></li>
                        
                          <li><a title="什么叫"回归初心" 以及技术成长突破的心态" href="15696591889118.html">什么叫"回归初心" 以及技术成长突破的心态</a></li>
                        

                    
                      <li class="side-title"><span>其他</span></li>
                        
                          <li><a title="理解矩阵" href="15936798966495.html">理解矩阵</a></li>
                        
                          <li><a title="cocopods重装解决framework not found Pods/no such module" href="15923063082414.html">cocopods重装解决framework not found Pods/no such module</a></li>
                        
                          <li><a title="pts导入bts2.0教程" href="15923063083603.html">pts导入bts2.0教程</a></li>
                        
                          <li><a title="gopush代码分析-comet模块" href="15923063083769.html">gopush代码分析-comet模块</a></li>
                        
                          <li><a title="Chrome Extension扩展开发之复制粘贴" href="15923063083833.html">Chrome Extension扩展开发之复制粘贴</a></li>
                        
                          <li><a title="iowait详解" href="15923063084125.html">iowait详解</a></li>
                        
                          <li><a title="mac安装mysql-python(with XAMPP)" href="15923063084788.html">mac安装mysql-python(with XAMPP)</a></li>
                        
                          <li><a title="App内使用H5页面的一个安全问题" href="15923063086512.html">App内使用H5页面的一个安全问题</a></li>
                        
                          <li><a title="PHP 通过Apns给Ios设备推送Notification" href="15923063086602.html">PHP 通过Apns给Ios设备推送Notification</a></li>
                        
                          <li><a title="python中使用import加载目录中全部文件" href="15923063087292.html">python中使用import加载目录中全部文件</a></li>
                        
                          <li><a title="kvm/virsh 异常断电导致虚拟机无法启动的修复实战" href="15923063088164.html">kvm/virsh 异常断电导致虚拟机无法启动的修复实战</a></li>
                        
                          <li><a title="Synology office error: User home service is not enabled" href="15923063081281.html">Synology office error: User home service is not enabled</a></li>
                        
                          <li><a title="git commit后自动检查php文件语法" href="15923063081235.html">git commit后自动检查php文件语法</a></li>
                        
                          <li><a title="梅林固件/R6300V2 安装Lcd4Linux显示屏" href="15923063081215.html">梅林固件/R6300V2 安装Lcd4Linux显示屏</a></li>
                        

                    
                      <li class="side-title"><span>About</span></li>
                        
                          <li><a title="Rainyluo's Blog" href="15923063081658.html">Rainyluo's Blog</a></li>
                        

                    
                      <li class="side-title"><span>PHP</span></li>
                        
                          <li><a title="二维数组排序 array multisort" href="15756185241314.html">二维数组排序 array multisort</a></li>
                        
                          <li><a title="PHP中的闭包理解" href="15931630289738.html">PHP中的闭包理解</a></li>
                        
                          <li><a title="reactPHP + lumen性能简测" href="15923063083212.html">reactPHP + lumen性能简测</a></li>
                        
                          <li><a title="QueryPath中文乱码问题,UTF8乱码问题解决" href="15923063084242.html">QueryPath中文乱码问题,UTF8乱码问题解决</a></li>
                        
                          <li><a title="WorkerMan的restart命令的一个Bug修复记录" href="15923063084445.html">WorkerMan的restart命令的一个Bug修复记录</a></li>
                        
                          <li><a title="PHP的多线程Curl,rolling Curl实现与坑" href="15923063085282.html">PHP的多线程Curl,rolling Curl实现与坑</a></li>
                        
                          <li><a title="用PHP-CLI在SHELL中输出颜色" href="15923063085495.html">用PHP-CLI在SHELL中输出颜色</a></li>
                        
                          <li><a title="使用GITHUB+JustWriting搭建BLOG" href="15923063087852.html">使用GITHUB+JustWriting搭建BLOG</a></li>
                        
                          <li><a title="[原创翻译]QueryPath PHP的Jquery实现,QueryPath教程" href="15923063087972.html">[原创翻译]QueryPath PHP的Jquery实现,QueryPath教程</a></li>
                        
                          <li><a title="(伪)异步实现加速PHP接口的返回速度" href="15923063089153.html">(伪)异步实现加速PHP接口的返回速度</a></li>
                        
                          <li><a title="PHP调试技巧" href="15922725010749.html">PHP调试技巧</a></li>
                        

                    
                  </ul>
                </nav>
                </div>
              </div>
            </div>
            <div class="large-9 medium-9 columns">

 <div class="markdown-body">
<h1>kvm/virsh 异常断电导致虚拟机无法启动的修复实战</h1>

<p>关键词:<br/>
mount qcow2 on linux<br/><br/>
xfs_repair  xfs磁盘修复<br/><br/>
kvm virsh console<br/><br/>
kvm虚拟机无法启动 故障排查 </p>

<p>公司异常断电,导致2台kvm的虚拟机无法启动了.<br/>
尝试修复的过程记录一下.</p>

<p>首先看报错,log一般都在/var/log/libvirt/qemu下面.<br/>
发现log很简单,没什么内容,也没有异常.谷歌一番发现可以打开debug的错误:</p>

<blockquote>
<p>修改/etc/libvirt/libvirtd.conf<br/><br/>
将日志级别设置为 1（调试）<br/><br/>
log_level = 1<br/><br/>
指定日志输出文件名称<br/><br/>
log_outputs=&quot;1:file:/var/log/libvirt/libvirtd.log&quot;<br/><br/>
重启libvirtd (systemctl restart libvirtd)  </p>
</blockquote>

<p>结果打出一堆虚拟机的debug log,并不是我想要的,没什么用.<br/><br/>
猜想是磁盘问题,但是console连接不了,virsh console vm1 之后没有反应.<br/><br/>
思路上,还是得能看到虚拟机的输出才好知道怎么办.于是尝试VNC连接,<br/><br/>
结果对着教程弄了半天,mac的VNC客户端还是连不上,一闪就断了.只能放弃了  </p>

<p>此时没信心了,寻思得重装了吧.先把文件恢复了.<br/><br/>
谷歌一下(mount qcow2 on linux),找到一篇很棒的教程:<a href="http://ask.xmodulo.com/mount-qcow2-disk-image-linux.html">http://ask.xmodulo.com/mount-qcow2-disk-image-linux.html</a>  </p>

<p>我们的虚拟机用的qcow2的格式,有一台是ext4有一台是xfs的文件系统.<br/><br/>
推荐用guestmount的方式,nbd方式还得编译内核才能挂载nbd模块,我这台宿主机centos7就没有nbd模块.后来我编译了一下挂载了,感觉也没什么大优势还挺麻烦.  </p>

<pre><code class="language-text">yum install libguestfs-tools
</code></pre>

<p>装好之后 guestmount -a /path/to/qcow2/image -m <device> /path/to/mount/point<br/><br/>
就可以把image里面的文件系统挂载到指定目录去,就可以看到文件了.<br/><br/>
eg:  </p>

<pre><code class="language-text">guestmount -a /var/lib/libvirt/images/xenserver.qcow2 -m /dev/sda1 /mnt
</code></pre>

<p>这个device,/dev/sda1可以随便打,然后会提示你正确的有哪几个.还挺方便的.<br/><br/>
能看到文件了,重装至少心里有底了.还是不满足,想看到虚拟机到底什么情况.着手研究console  </p>

<p>找到的教程(<a href="https://blog.csdn.net/lemontree1945/article/details/80461037">https://blog.csdn.net/lemontree1945/article/details/80461037</a> 还有<a href="https://www.oldboyedu.com/zuixin_wenzhang/index/id/366.html">https://www.oldboyedu.com/zuixin_wenzhang/index/id/366.html</a>) 都是得进入系统才行的.但是现在进不去系统,而且我见过console是可以显示进去系统前的启动log的,所以肯定不是系统打开的TTY Console.那么猜测就是Grub的问题了.    </p>

<p>谷歌,关键词(kvm grub console),基本上学习了一圈之后总结如下:<br/>
前提:文件系统能通过guestmount成功mount,主要mount的boot分区(不是root),这个分区一般存的都是引导文件和grub的配置文件.在能正常启动的机器上,就是对应的/boot 目录.文件内容如下<br/><br/>
<img src="media/15652431791895/15652448513923.jpg" alt=""/>  </p>

<p>对应的关系  </p>

<p><img src="media/15652431791895/15652449131835.jpg" alt=""/>  </p>

<p>在用guestmount 的时候提示你挂载哪个磁盘的时候都写的很清楚,挂载boot这个就ok了.这个盘一般也不会坏,都能挂成功.  </p>

<h3 id="toc_0">对于Centos6</h3>

<p>我司centos6用的是grub(没有2).挂载好后,修改 grub/grub.conf 文件</p>

<pre><code class="language-text">title CentOS (2.6.32-696.13.2.el6.x86_64)
    root (hd0,0)
    kernel /vmlinuz-2.6.32-696.13.2.el6.x86_64 ro root=/dev/mapper/vg_2cloo-lv_root rd_NO_LUKS LANG=en_US.UTF-8 rd_LVM_LV=vg_2cloo/lv_swap rd_NO_MD SYSFONT=latarcyrheb-sun16 crashkernel=auto rd_LVM_LV=vg_2cloo/lv_root  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet console=ttyS0
    initrd /initramfs-2.6.32-696.13.2.el6.x86_64.img
</code></pre>

<p>这个每一项对应的是我们开机时候在屏幕上能够看到的启动项.在kernel一行 quiet参数后面加 console=ttyS0 <br/>
即可.<img src="media/15652431791895/15652451533364.jpg" alt=""/></p>

<h3 id="toc_1">对于centos 7</h3>

<p>centos7使用的是Grub2,推测跟grub类似应该.打开grub2/grub.cfg,发现文件内容完全不一样了,是shell形式的了<br/>
稍微看了一下,形式差不多 也是定义了每个启动项,找到  </p>

<pre><code class="language-text">linux16 /vmlinuz-3.10.0-514.2.2.el7.x86_64 root=/dev/mapper/centos-root ro ipv6.disable=1 crashkernel=auto rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet console=ttyS0
</code></pre>

<p>在quiet后添加console=ttyS0好了  </p>

<p>现在启动后,virsh console vm1 能成功进入console了,基本上成功一大半了.<br/><br/>
然后dmesg看一下启动log,发现xfs挂载有问题,进入了centos emergency mode紧急模式.<br/><br/>
对于xfs系统来说:<br/><br/>
/sbin/xfs_repair /dev/mapper/centos-root看一下,一般会提示有错误.<br/><br/>
然后加-L 参数修复错误.修复之前最好备份一下虚拟机, virsh destroy vm1然后把img文件复制一个出来好了.  </p>

<p>执行/sbin/xfs_repair -L /dev/mapper/centos-root,有很多不一致的情况都修复好了.然后reboot 系统就起来了,美滋滋.<br/><br/>
对于ext4格式的系统,可以  </p>

<pre><code class="language-text">umount /
fsck.ext4 -y /dev/sda1
</code></pre>

<p>尝试修复就ok了  </p>


</div>

<br /><br />
<hr />

<div class="row clearfix">
  <div class="large-6 columns">
	<div class="text-left" style="padding:15px 0px;">
		
	        <a href="15923063087972.html"  title="Previous Post: [原创翻译]QueryPath PHP的Jquery实现,QueryPath教程">&laquo; [原创翻译]QueryPath PHP的Jquery实现,QueryPath教程</a>
	    
	</div>
  </div>
  <div class="large-6 columns">
	<div class="text-right" style="padding:15px 0px;">
		
	        <a href="15923063089153.html" 
	        title="Next Post: (伪)异步实现加速PHP接口的返回速度">(伪)异步实现加速PHP接口的返回速度 &raquo;</a>
	    
	</div>
  </div>
</div>

<div class="row">
<div style="padding:0px 0.93em;" class="share-comments">

</div>
</div>
<script type="text/javascript">
	$(function(){
		var currentURL = '15923063088164.html';
		$('#side-nav a').each(function(){
			if($(this).attr('href') == currentURL){
				$(this).parent().addClass('active');
			}
		});
	});
</script>  
</div></div>


<div class="page-bottom">
  <div class="row">
  <hr />
  <div class="small-9 columns">
  <p class="copyright">Copyright &copy; 2020
备案信息: <a target="_blank" href="http://www.mweb.im">京ICP备14056617号</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
  <div class="small-3 columns">
  <p class="copyright text-right"><a href="#header">TOP</a></p>
  </div>
   
  </div>
</div>

        </section>
      </div>
    </div>
    
    
    <script src="asset/js/foundation.min.js"></script>
    <script src="asset/js/foundation/foundation.offcanvas.js"></script>
    <script>
      $(document).foundation();

     
    </script>
    


  </body>
</html>
