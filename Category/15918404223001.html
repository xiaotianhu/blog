<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  Hyperf源码阅读 - 框架初始化之容器初始化 - Rainyluo's BLOG
  
  </title>
 <meta name="description" content="">
 <link href="atom.xml" rel="alternate" title="Rainyluo's BLOG" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />

    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
    <script src="asset/highlightjs/highlight.pack.js"></script>
    <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
    <script>hljs.initHighlightingOnLoad();</script>
    
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>

<div id="header">
    <h1><a href="index.html">Rainyluo's BLOG</a></h1>
</div>

</nav>
        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; Rainyluo's BLOG</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
      <li><a href="index.html">Home</a></li>
      
        <li class="divider"></li>
        <li><label>源码阅读</label></li>

          
            <li><a title="Hyperf源码阅读 - 框架初始化之Application" href="15919610280346.html">Hyperf源码阅读 - 框架初始化之Application</a></li>
          
            <li><a title="Hyperf源码阅读 - 框架初始化之容器初始化" href="15918404223001.html">Hyperf源码阅读 - 框架初始化之容器初始化</a></li>
          
            <li><a title="Hyperf源码阅读 - Router流程" href="15918401062183.html">Hyperf源码阅读 - Router流程</a></li>
          

      
        <li class="divider"></li>
        <li><label>随感</label></li>

          
            <li><a title="如何变得平庸" href="15923063082122.html">如何变得平庸</a></li>
          
            <li><a title="一个实用主义者的反思" href="15923063082072.html">一个实用主义者的反思</a></li>
          
            <li><a title="2018-08-01 感想" href="15923063081475.html">2018-08-01 感想</a></li>
          
            <li><a title="2019的成长" href="15923063084995.html">2019的成长</a></li>
          
            <li><a title="细节与功利主义：致那些同我一样想突破自己技术层级的朋友们" href="15771974682027.html">细节与功利主义：致那些同我一样想突破自己技术层级的朋友们</a></li>
          
            <li><a title="审美是一切美好追求的基础" href="15706010504336.html">审美是一切美好追求的基础</a></li>
          
            <li><a title="什么叫"回归初心" 以及技术成长突破的心态" href="15696591889118.html">什么叫"回归初心" 以及技术成长突破的心态</a></li>
          

      
        <li class="divider"></li>
        <li><label>其他</label></li>

          
            <li><a title="cocopods重装解决framework not found Pods/no such module" href="15923063082414.html">cocopods重装解决framework not found Pods/no such module</a></li>
          
            <li><a title="pts导入bts2.0教程" href="15923063083603.html">pts导入bts2.0教程</a></li>
          
            <li><a title="gopush代码分析-comet模块" href="15923063083769.html">gopush代码分析-comet模块</a></li>
          
            <li><a title="Chrome Extension扩展开发之复制粘贴" href="15923063083833.html">Chrome Extension扩展开发之复制粘贴</a></li>
          
            <li><a title="iowait详解" href="15923063084125.html">iowait详解</a></li>
          
            <li><a title="mac安装mysql-python(with XAMPP)" href="15923063084788.html">mac安装mysql-python(with XAMPP)</a></li>
          
            <li><a title="App内使用H5页面的一个安全问题" href="15923063086512.html">App内使用H5页面的一个安全问题</a></li>
          
            <li><a title="PHP 通过Apns给Ios设备推送Notification" href="15923063086602.html">PHP 通过Apns给Ios设备推送Notification</a></li>
          
            <li><a title="python中使用import加载目录中全部文件" href="15923063087292.html">python中使用import加载目录中全部文件</a></li>
          
            <li><a title="kvm/virsh 异常断电导致虚拟机无法启动的修复实战" href="15923063088164.html">kvm/virsh 异常断电导致虚拟机无法启动的修复实战</a></li>
          
            <li><a title="Synology office error: User home service is not enabled" href="15923063081281.html">Synology office error: User home service is not enabled</a></li>
          
            <li><a title="git commit后自动检查php文件语法" href="15923063081235.html">git commit后自动检查php文件语法</a></li>
          
            <li><a title="梅林固件/R6300V2 安装Lcd4Linux显示屏" href="15923063081215.html">梅林固件/R6300V2 安装Lcd4Linux显示屏</a></li>
          

      
        <li class="divider"></li>
        <li><label>About</label></li>

          
            <li><a title="Rainyluo's Blog" href="15923063081658.html">Rainyluo's Blog</a></li>
          

      
        <li class="divider"></li>
        <li><label>PHP</label></li>

          
            <li><a title="reactPHP + lumen性能简测" href="15923063083212.html">reactPHP + lumen性能简测</a></li>
          
            <li><a title="QueryPath中文乱码问题,UTF8乱码问题解决" href="15923063084242.html">QueryPath中文乱码问题,UTF8乱码问题解决</a></li>
          
            <li><a title="WorkerMan的restart命令的一个Bug修复记录" href="15923063084445.html">WorkerMan的restart命令的一个Bug修复记录</a></li>
          
            <li><a title="PHP的多线程Curl,rolling Curl实现与坑" href="15923063085282.html">PHP的多线程Curl,rolling Curl实现与坑</a></li>
          
            <li><a title="用PHP-CLI在SHELL中输出颜色" href="15923063085495.html">用PHP-CLI在SHELL中输出颜色</a></li>
          
            <li><a title="使用GITHUB+JustWriting搭建BLOG" href="15923063087852.html">使用GITHUB+JustWriting搭建BLOG</a></li>
          
            <li><a title="[原创翻译]QueryPath PHP的Jquery实现,QueryPath教程" href="15923063087972.html">[原创翻译]QueryPath PHP的Jquery实现,QueryPath教程</a></li>
          
            <li><a title="(伪)异步实现加速PHP接口的返回速度" href="15923063089153.html">(伪)异步实现加速PHP接口的返回速度</a></li>
          
            <li><a title="PHP调试技巧" href="15922725010749.html">PHP调试技巧</a></li>
          
            <li><a title="二维数组排序 array multisort" href="15756185241314.html">二维数组排序 array multisort</a></li>
          

      
      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>

        <section id="main-content" role="main" class="scroll-container">

          <div class="row">
            <div class="large-3 medium-3 columns">
              <div class="hide-for-small">
                <div class="sidebar">
                <nav>
                  <ul id="side-nav" class="side-nav">

                    
                      <li class="side-title"><span>源码阅读</span></li>
                        
                          <li><a title="Hyperf源码阅读 - 框架初始化之Application" href="15919610280346.html">Hyperf源码阅读 - 框架初始化之Application</a></li>
                        
                          <li><a title="Hyperf源码阅读 - 框架初始化之容器初始化" href="15918404223001.html">Hyperf源码阅读 - 框架初始化之容器初始化</a></li>
                        
                          <li><a title="Hyperf源码阅读 - Router流程" href="15918401062183.html">Hyperf源码阅读 - Router流程</a></li>
                        

                    
                      <li class="side-title"><span>随感</span></li>
                        
                          <li><a title="如何变得平庸" href="15923063082122.html">如何变得平庸</a></li>
                        
                          <li><a title="一个实用主义者的反思" href="15923063082072.html">一个实用主义者的反思</a></li>
                        
                          <li><a title="2018-08-01 感想" href="15923063081475.html">2018-08-01 感想</a></li>
                        
                          <li><a title="2019的成长" href="15923063084995.html">2019的成长</a></li>
                        
                          <li><a title="细节与功利主义：致那些同我一样想突破自己技术层级的朋友们" href="15771974682027.html">细节与功利主义：致那些同我一样想突破自己技术层级的朋友们</a></li>
                        
                          <li><a title="审美是一切美好追求的基础" href="15706010504336.html">审美是一切美好追求的基础</a></li>
                        
                          <li><a title="什么叫"回归初心" 以及技术成长突破的心态" href="15696591889118.html">什么叫"回归初心" 以及技术成长突破的心态</a></li>
                        

                    
                      <li class="side-title"><span>其他</span></li>
                        
                          <li><a title="cocopods重装解决framework not found Pods/no such module" href="15923063082414.html">cocopods重装解决framework not found Pods/no such module</a></li>
                        
                          <li><a title="pts导入bts2.0教程" href="15923063083603.html">pts导入bts2.0教程</a></li>
                        
                          <li><a title="gopush代码分析-comet模块" href="15923063083769.html">gopush代码分析-comet模块</a></li>
                        
                          <li><a title="Chrome Extension扩展开发之复制粘贴" href="15923063083833.html">Chrome Extension扩展开发之复制粘贴</a></li>
                        
                          <li><a title="iowait详解" href="15923063084125.html">iowait详解</a></li>
                        
                          <li><a title="mac安装mysql-python(with XAMPP)" href="15923063084788.html">mac安装mysql-python(with XAMPP)</a></li>
                        
                          <li><a title="App内使用H5页面的一个安全问题" href="15923063086512.html">App内使用H5页面的一个安全问题</a></li>
                        
                          <li><a title="PHP 通过Apns给Ios设备推送Notification" href="15923063086602.html">PHP 通过Apns给Ios设备推送Notification</a></li>
                        
                          <li><a title="python中使用import加载目录中全部文件" href="15923063087292.html">python中使用import加载目录中全部文件</a></li>
                        
                          <li><a title="kvm/virsh 异常断电导致虚拟机无法启动的修复实战" href="15923063088164.html">kvm/virsh 异常断电导致虚拟机无法启动的修复实战</a></li>
                        
                          <li><a title="Synology office error: User home service is not enabled" href="15923063081281.html">Synology office error: User home service is not enabled</a></li>
                        
                          <li><a title="git commit后自动检查php文件语法" href="15923063081235.html">git commit后自动检查php文件语法</a></li>
                        
                          <li><a title="梅林固件/R6300V2 安装Lcd4Linux显示屏" href="15923063081215.html">梅林固件/R6300V2 安装Lcd4Linux显示屏</a></li>
                        

                    
                      <li class="side-title"><span>About</span></li>
                        
                          <li><a title="Rainyluo's Blog" href="15923063081658.html">Rainyluo's Blog</a></li>
                        

                    
                      <li class="side-title"><span>PHP</span></li>
                        
                          <li><a title="reactPHP + lumen性能简测" href="15923063083212.html">reactPHP + lumen性能简测</a></li>
                        
                          <li><a title="QueryPath中文乱码问题,UTF8乱码问题解决" href="15923063084242.html">QueryPath中文乱码问题,UTF8乱码问题解决</a></li>
                        
                          <li><a title="WorkerMan的restart命令的一个Bug修复记录" href="15923063084445.html">WorkerMan的restart命令的一个Bug修复记录</a></li>
                        
                          <li><a title="PHP的多线程Curl,rolling Curl实现与坑" href="15923063085282.html">PHP的多线程Curl,rolling Curl实现与坑</a></li>
                        
                          <li><a title="用PHP-CLI在SHELL中输出颜色" href="15923063085495.html">用PHP-CLI在SHELL中输出颜色</a></li>
                        
                          <li><a title="使用GITHUB+JustWriting搭建BLOG" href="15923063087852.html">使用GITHUB+JustWriting搭建BLOG</a></li>
                        
                          <li><a title="[原创翻译]QueryPath PHP的Jquery实现,QueryPath教程" href="15923063087972.html">[原创翻译]QueryPath PHP的Jquery实现,QueryPath教程</a></li>
                        
                          <li><a title="(伪)异步实现加速PHP接口的返回速度" href="15923063089153.html">(伪)异步实现加速PHP接口的返回速度</a></li>
                        
                          <li><a title="PHP调试技巧" href="15922725010749.html">PHP调试技巧</a></li>
                        
                          <li><a title="二维数组排序 array multisort" href="15756185241314.html">二维数组排序 array multisort</a></li>
                        

                    
                  </ul>
                </nav>
                </div>
              </div>
            </div>
            <div class="large-9 medium-9 columns">

 <div class="markdown-body">
<h1>Hyperf源码阅读 - 框架初始化之容器初始化</h1>

<p>框架入口bin/hyperf.php 跟Laravel一样,先初始化容器,剩下的初始化交给容器来做.<br/>
这里面用了一个闭包,让我想起了JS,防止污染全局变量空间.这个跟常驻进程有关系应该,FPM模型每次释放变量就不需要这么搞.<br/>
容器的定义在config/container.php</p>

<p><strong>config/container.php</strong><br/>
初始化Container,注入依赖Hyperf\Di\Definition\DefinitionSourceFactory<br/>
再把Container对象给到ApplicationContext.这个ApplicationContext可以理解为每次请求的应用上下文,猜测应该是协程安全的,类似线程安全.用来管理每次请求的框架应用上下文.</p>

<p><strong>vendor/hyperf/di/src/Definition/DefinitionSourceFactory.php</strong><br/>
Definition是Hyperf依赖注入里面的概念,理解为&quot;抽象定义&quot;,比如接口 抽象类什么的.在Laravel里的概念叫Contracts,合约 都是差不多意思</p>

<p>传入给Container的依赖是<br/>
(new DefinitionSourceFactory(true))()<br/>
就是先调用__construct(),然后又会调用__invoke(),把invoke的值返回给Container.</p>

<p>construct设置了两个类变量,很简单</p>

<p>__invoke()主要是初始化一些配置.<br/>
$configFromProviders 是Hyperf的又一个概念;每个vendor里面的组件,通过ConfigProvider机制,把组件自己的配置注入到框架里面,这个注入流程在此完成的.注意每个ConfigProvider.php文件是通过各自组件的Composer.json的extra字段定义的, 在这里读取的时候是通过项目根目录的Composer.lock文件获取的,如果开发本地包,需要添加本地的respositories才会更新lock文件.</p>

<p>$configFromProviders = ProviderConfig::load() <br/>
 就是通过调用Composer的相关方法,获取到每个组件的extra配置拿到全部extra的数组,从而生成一个全部组件的ConfigProvider数组</p>

<p>$serverDependencies 从config/dependencies.php获得dependency的配置,也就是用户自己定义的接口与实现的绑定关系</p>

<p>继续加载配置config/autoload/annotations.php,注解相关的配置.</p>

<p>生成一个$scanConfig = new ScanConfig()的对象后,把依赖注入到DefinitionSource对象,工厂的功能就完成了,最后我们得到一个DefinitionSource对象.</p>

<p><strong>vendor/hyperf/di/src/Definition/DefinitionSource.php</strong><br/>
 __construct()中<br/>
 生成了一个Hyperf\Di\Annotation\Scanner对象.</p>

<ul>
<li><p>调用\(this-&gt;scan()<br/>
\)paths是在DefinitionSourceFactory中生成的ScanConfig-&gt;getDirs()来获取的,就是在DefinitionSourceFactory中合并的各个配置的 \(scanDirs.<br/>
遍历每个目录\)path,看前缀是vendor还是app,从而把需要遍历的目录分组 app内还是vendor内的目录</p></li>
<li><p>调用\(this-&gt;normalizeSource()把DefinitionSourceFactory中获取的用户在config/autoload/dependencies.php中配置的绑定关系,通过\)this-&gt;normalizeDefinition()方法转换成一个&quot;正常的&quot;Definition,也就是实例化,存到$this-&gt;source变量中.</p>
<p>construct初始化就完成了.</p>
<p>再看看什么是normalizeDefinition()<br/>
如果\(definition是对象,并且实现了__invode()可以直接像函数一样调用,则传给FactoryDefinition <br/>
如果\)definition是函数,也一样传给FactoryDefinition</p></li>
</ul>

<p>如果是普通类,则通过ObjectDefinition对象包装一下后,传给$this-&gt;autowire()</p>

<p><em>autowire()</em>是真正把类实例化成为对象的地方.但是此函数还不实例化,而是生成一个ObjectDefinition对象;这个对象包含了需要被实例化的类的基础信息,construct有没有啊,需要哪些依赖啊,之类的信息.</p>

<ul>
<li>先通过ReflectionManager::reflectClass()拿到反射后的类,判断__construct()是不是存在而且是public的.如果存在且public则可以调用,通过getParametersDefinition()拿到type hint类定义,传给completeConstructorInjection-&gt;completeConstructorInjection来丰富construct需要的参数;</li>
<li>然后处理通过注解注入对象的情况.通过AnnotationCollector::get()获取之前Scan到的全部需要处理的注入注解;</li>
<li>然后获取这个类是不是需要proxy代理,在$this-&gt;isNeedProxy判断;通过代理来实现AOP切面;
<ul>
<li><strong>isNeexProxy()</strong>
<ul>
<li>先通过AspectCollector获取到类需要的aspect切面;</li>
<li>获取一下类和方法的全部注解,判断一下条件,返回是否需要注解 true/false</li>
</ul></li>
</ul></li>
<li>是否proxy的信息 存入$definition 齐活</li>
</ul>

<pre><code class="language-text">至此,Container里面装满了ObjectDefinition,各种初始化需要的类都创建好装在Container容器里了.然后开始运行
bin/hyperf.php里
$application = $container-&gt;get(\Hyperf\Contract\ApplicationInterface::class);
$application-&gt;run();
通过容器拿到Application然后run()起来
</code></pre>

<p><strong>继续看一下Container的内部</strong><br/>
Hyperf\Di\Container(vendor/hyperf/di/src/container.php)是核心的容器类,负责app应用内上层的依赖管理;之前的一些ObjectDefinition算是比较底层的依赖;</p>

<ul>
<li>__construct()初始化,传入的依赖为$definitionSource,就是前面通过DefinitionSource.php生成的ObjectDefinition对象数组;definitionResolver负责具体的resolve,就是真正把类实例化变成对象</li>
<li>make()实例化方法,会根据一个name生成一个对象实体;具体方式 先查一下缓存,getDefinition(\(name),这个缓存是本地的数组;然后调用\)this-&gt;definitionResolver-&gt;resolve()来实例化,resolver是ResolverDispatcher实现的</li>
<li><strong>resolve的实现:ResolverDispatcher</strong>
resolve分2种:如果实现了SelfResolvingDefinitionInterface,就是自己可以resolve的,直接调自己家的resolve()方法;如果不是,则看一下是属于ObjectDefinition普通类还是FactoryDefinition工厂类,然后用对应的Resolver来resolve.<br/>
以ObjectDefinition为例,具体的new对象过程在createInstance()方法;先判断一下是不是isInstantiable并且Exist的;符合条件的,通过parameterResolver解析出construct需要的params,最后调用new方法 把params传给construct,才真正完成一个类的实例化,得到一个Entity实体对象.</li>
</ul>


</div>

<br /><br />
<hr />

<div class="row clearfix">
  <div class="large-6 columns">
	<div class="text-left" style="padding:15px 0px;">
		
	        <a href="15919610280346.html"  title="Previous Post: Hyperf源码阅读 - 框架初始化之Application">&laquo; Hyperf源码阅读 - 框架初始化之Application</a>
	    
	</div>
  </div>
  <div class="large-6 columns">
	<div class="text-right" style="padding:15px 0px;">
		
	        <a href="15918401062183.html" 
	        title="Next Post: Hyperf源码阅读 - Router流程">Hyperf源码阅读 - Router流程 &raquo;</a>
	    
	</div>
  </div>
</div>

<div class="row">
<div style="padding:0px 0.93em;" class="share-comments">

</div>
</div>
<script type="text/javascript">
	$(function(){
		var currentURL = '15918404223001.html';
		$('#side-nav a').each(function(){
			if($(this).attr('href') == currentURL){
				$(this).parent().addClass('active');
			}
		});
	});
</script>  
</div></div>


<div class="page-bottom">
  <div class="row">
  <hr />
  <div class="small-9 columns">
  <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
  <div class="small-3 columns">
  <p class="copyright text-right"><a href="#header">TOP</a></p>
  </div>
   
  </div>
</div>

        </section>
      </div>
    </div>
    
    
    <script src="asset/js/foundation.min.js"></script>
    <script src="asset/js/foundation/foundation.offcanvas.js"></script>
    <script>
      $(document).foundation();

     
    </script>
    


  </body>
</html>
